<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>実車評価支援ツール</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0ea5e9" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="leaflet.css" />

  <style>
    :root { --ui-bg:#fff; --ui-shadow: 0 6px 24px rgba(0,0,0,.18); }
    html,body,#map { height: 100%; margin: 0; }
    #map { background:#f2f2f2; }

    /* 上部パネル */
    #panel {
      position: absolute; inset: 10px auto auto 10px;
      z-index: 1000; background: var(--ui-bg);
      padding: 10px 12px; border-radius: 14px; box-shadow: var(--ui-shadow);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      min-width: 280px; max-width: min(94vw, 420px);
    }
    #panel h1 { margin: 0 0 8px; font-size: 14px; font-weight: 700; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin: 6px 0; }
    label { font-size: 12px; }
    .small { font-size: 11px; color: #555; }
    .badge { display:inline-block; padding:2px 6px; background:#eef; border:1px solid #ccd; border-radius: 6px; font-size: 11px; }
    button, input[type="file"] { font: inherit; }
    button { cursor: pointer; padding: 6px 10px; border-radius: 10px; border: 1px solid #ddd; background:#fff; }
    #track { background:#16a34a; color:#fff; border-color:#16a34a; }
    #stop { background:#ef4444; color:#fff; border-color:#ef4444; }
    #recenter { background:#0ea5e9; color:#fff; border-color:#0ea5e9; }

    /* 右下のフローティング「現在地へ」 */
    #fab-recenter {
      position: absolute; right: 14px; bottom: 14px; z-index: 1000;
      width: 50px; height: 50px; border-radius: 50%;
      display:grid; place-items:center;
      background:#0ea5e9; color:#fff; box-shadow: var(--ui-shadow); border:none;
      font-size: 20px; cursor: pointer;
    }

    /* スライダー */
    input[type="range"] { width: 100%; }

    /* モバイルでパネルが邪魔な時にたたむ */
    #togglePanel {
      position:absolute; left:10px; top:10px; z-index:1001;
      background:#0ea5e9; color:#fff; border:none; border-radius: 10px;
      box-shadow: var(--ui-shadow); padding:6px 10px; display:none;
    }
    @media (max-width: 640px) {
      #togglePanel { display:block; }
      #panel.compact { display: none; }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <button id="togglePanel">メニュー</button>

  <div id="panel">
    <h1>実車評価支援ツール</h1>

    <div class="row">
      <input type="file" id="file" accept=".kml,.kmz" />
      <button id="clear">クリア</button>
    </div>

    <div class="row">
      <button id="track">位置追跡を開始</button>
      <button id="stop">停止</button>
      <button id="recenter">現在地へ</button>
      <label style="display:inline-flex; align-items:center; gap:6px;">
        <input type="checkbox" id="follow" checked /> 自動追従
      </label>
    </div>

    <div class="row">
      <label>通知距離: <span id="thv" class="badge">100m</span></label>
      <input id="th" type="range" min="20" max="300" value="100" />
    </div>

    <div class="row">
      <button id="tts">音声テスト</button>
      <span class="small" id="stat"></span>
    </div>

    <div class="small">
      ※ オンライン時に表示した地図は自動的に端末へキャッシュされ、圏外でも表示されます。
    </div>
  </div>

  <!-- 右下のフローティング現在地ボタン（親指で押しやすい） -->
  <button id="fab-recenter" title="現在地へ">📍</button>

  <!-- PWA: Service Worker 登録 -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    }
  </script>

  <!-- 依存ライブラリ -->
  <script src="leaflet.js"></script>
  <script src="jszip.min.js"></script>
  <script src="togeojson.umd.js"></script>

  <script>
    // --- Leaflet マップ初期化 ---
    const map = L.map('map', { zoomControl: true }).setView([35.0, 135.0], 14);

    // OSM タイル（単一ホスト + CORS 指定）※SWがキャッシュ
    const osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      crossOrigin: true,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // --- 状態 ---
    let threshold = 100;                // 通知距離（m）
    let points = [];                    // {latlng, name, desc, announced}
    let watchId = null;
    let meLayer = null;                 // 現在地表示
    let routeLayer = null, pointLayer = null;
    let lastHere = null;                // 最終現在地
    let follow = true;                  // 自動追従

    // --- 要素 ---
    const elTh   = document.getElementById('th');
    const elThV  = document.getElementById('thv');
    const elStat = document.getElementById('stat');
    const elFollow = document.getElementById('follow');
    const togglePanelBtn = document.getElementById('togglePanel');
    const panel = document.getElementById('panel');

    // --- UI イベント ---
    togglePanelBtn.addEventListener('click', () => {
      panel.classList.toggle('compact');
    });

    elTh.addEventListener('input', () => {
      threshold = +elTh.value;
      elThV.textContent = `${threshold}m`;
    });

    elFollow.addEventListener('change', () => {
      follow = elFollow.checked;
      if (follow && lastHere) map.setView(lastHere);
    });

    document.getElementById('recenter').addEventListener('click', recenterNow);
    document.getElementById('fab-recenter').addEventListener('click', recenterNow);
    function recenterNow() {
      if (lastHere) {
        follow = true;
        elFollow.checked = true;
        map.setView(lastHere, map.getZoom() < 16 ? 16 : map.getZoom());
      } else {
        // 最初の位置取得（単発）
        navigator.geolocation.getCurrentPosition(
          pos => {
            const here = L.latLng(pos.coords.latitude, pos.coords.longitude);
            map.setView(here, 16);
          },
          err => alert('位置取得に失敗: ' + err.message),
          { enableHighAccuracy: true, timeout: 10000 }
        );
      }
    }

    document.getElementById('tts').addEventListener('click', () => speak('音声テストです'));

    document.getElementById('clear').addEventListener('click', () => {
      if (routeLayer) map.removeLayer(routeLayer);
      if (pointLayer) map.removeLayer(pointLayer);
      points = [];
    });

    document.getElementById('track').addEventListener('click', () => {
      if (watchId) navigator.geolocation.clearWatch(watchId);
      watchId = navigator.geolocation.watchPosition(onPos, onErr, {
        enableHighAccuracy: true, maximumAge: 1000, timeout: 15000
      });
    });

    document.getElementById('stop').addEventListener('click', () => {
      if (watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; }
      elStat.textContent = '';
    });

    document.getElementById('file').addEventListener('change', onFile);

    // 地図を触ったら自動追従 OFF
    map.on('dragstart zoomstart', () => { follow = false; elFollow.checked = false; });

    // --- ユーティリティ ---
    function speak(text) {
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'ja-JP';
      try { speechSynthesis.speak(u); } catch {}
    }

    function dist(a, b) {
      const R = 6371000, toRad = d => d * Math.PI/180;
      const dlat = toRad(b.lat - a.lat), dlon = toRad(b.lng - a.lng);
      const s = Math.sin(dlat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dlon/2)**2;
      return 2 * R * Math.asin(Math.sqrt(s));
    }

    function stripHtml(html) {
      if (!html) return '';
      const tmp = document.createElement('div');
      tmp.innerHTML = html;
      return (tmp.textContent || tmp.innerText || '').trim();
    }

    // --- KML/KMZ ローダ ---
    async function onFile(ev) {
      const f = ev.target.files[0];
      if (!f) return;

      const isKMZ = /\.kmz$/i.test(f.name);
      let kmlText = null;

      try {
        if (isKMZ) {
          const buf = await f.arrayBuffer();
          const zip = await JSZip.loadAsync(buf);
          let kmlEntry = null;
          zip.forEach((p, entry) => { if (!kmlEntry && p.toLowerCase().endsWith('.kml')) kmlEntry = entry; });
          if (!kmlEntry) return alert('KMZ内にKMLが見つかりません。');
          kmlText = await kmlEntry.async('string');
        } else {
          kmlText = await f.text();
        }
      } catch (e) {
        alert('ファイル読み込みに失敗: ' + e.message);
        return;
      }

      const kmlDom = new DOMParser().parseFromString(kmlText, 'text/xml');
      const gj = toGeoJSON.kml(kmlDom);

      // 既存レイヤ削除
      if (routeLayer) map.removeLayer(routeLayer);
      if (pointLayer) map.removeLayer(pointLayer);
      points = [];

      // ルート（LineString / MultiLineString）
      const lineFeats = gj.features.filter(ft => ft.geometry && /Line/i.test(ft.geometry.type));
      const lines = lineFeats.map(ft =>
        L.polyline(ft.geometry.coordinates.map(c => [c[1], c[0]]), { color:'#2b8a3e', weight:4 })
      );
      if (lines.length) routeLayer = L.layerGroup(lines).addTo(map);

      // チェックポイント（Point）
      const ptFeats = gj.features.filter(ft => ft.geometry && ft.geometry.type === 'Point');
      pointLayer = L.geoJSON({ type: 'FeatureCollection', features: ptFeats }, {
        pointToLayer: (ft, latlng) => L.circleMarker(latlng, {
          radius: 7, color:'#1e3a8a', weight: 2, fillColor:'#60a5fa', fillOpacity:.9
        }),
        onEachFeature: (ft, layer) => {
          const name = (ft.properties && ft.properties.name) ? stripHtml(ft.properties.name) : 'チェックポイント';
          const descRaw = (ft.properties && ft.properties.description) ? ft.properties.description : '';
          const desc = stripHtml(descRaw);
          layer.bindPopup(`<b>${name}</b><br>${desc}`);
          points.push({ latlng: layer.getLatLng(), name, desc, announced: false });
        }
      }).addTo(map);

      // ビュー合わせ
      const group = [];
      if (routeLayer) group.push(routeLayer);
      if (pointLayer) group.push(pointLayer);
      if (group.length) {
        const g = L.featureGroup(group);
        map.fitBounds(g.getBounds().pad(0.2));
      }
    }

    // --- 現在地処理 ---
    function onPos(pos) {
      const { latitude, longitude, accuracy, speed } = pos.coords;
      const here = L.latLng(latitude, longitude);
      lastHere = here;

      elStat.textContent = `精度 ${Math.round(accuracy||0)}m / 速度 ${speed!=null ? Math.round(speed*3.6) : '-'}km/h`;

      if (!meLayer) {
        meLayer = L.circleMarker(here, { radius: 8, color:'#dc2626', weight:3, fillColor:'#fecaca', fillOpacity:1 })
          .addTo(map);
      } else {
        meLayer.setLatLng(here);
      }

      if (follow) map.panTo(here, { animate: false });

      // 距離判定（未通知のみ）
      for (const p of points) {
        if (p.announced) continue;
        if (dist(here, p.latlng) <= threshold) {
          p.announced = true;
          speak(`${p.name}。 ${p.desc}`);
        }
      }
    }
    function onErr(err) {
      alert('位置取得に失敗: ' + err.message);
    }
  </script>
</body>
</html>
